// src/app/funcionalidades/gerenciamento-matriculas/iniciar-matricula/iniciar-matricula.page.html

<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/paineis/interesse-matricula/lista-declaracoes"></ion-back-button>
    </ion-buttons>
    <ion-title>Iniciar Matrícula</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="carregando" class="loading-container">
    <ion-spinner name="dots"></ion-spinner>
    <p class="loading-text">Carregando dados da declaração...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="erro && !carregando" class="error-state">
    <ion-icon name="alert-circle-outline" size="large"></ion-icon>
    <h2>Erro ao Carregar</h2>
    <p>{{ erro }}</p>
    <ion-button color="primary" (click)="carregarDados()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Tentar Novamente
    </ion-button>
  </div>

  <!-- Content -->
  <div *ngIf="interesse && !carregando" class="content-container">
    <!-- Dados da Declaração de Interesse -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Dados da Declaração</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list lines="none">
          <ion-item-group>
            <ion-item-divider>
              <ion-label>Informações do Aluno</ion-label>
            </ion-item-divider>

            <ion-item>
              <ion-label>
                <strong>Protocolo:</strong>
                <p>{{ interesse.protocolo }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <strong>Nome Completo:</strong>
                <p>{{ interesse.nomeCompleto }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <strong>CPF:</strong>
                <p>{{ interesse.cpf }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <strong>Série Desejada:</strong>
                <p>{{ interesse.serieDesejada }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <strong>Tipo de Cota:</strong>
                <p>{{ formatarTipoCota(interesse.tipoCota) }}</p>
              </ion-label>
            </ion-item>
          </ion-item-group>

          <ion-item-group>
            <ion-item-divider>
              <ion-label>Informações de Contato</ion-label>
            </ion-item-divider>

            <ion-item>
              <ion-label>
                <strong>E-mail:</strong>
                <p>{{ interesse.email }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <strong>Telefone:</strong>
                <p>{{ interesse.telefone }}</p>
              </ion-label>
            </ion-item>
          </ion-item-group>

          <ion-item-group>
            <ion-item-divider>
              <ion-label>Status Atual</ion-label>
            </ion-item-divider>

            <ion-item>
              <ion-label>
                <strong>Status:</strong>
                <ion-chip [color]="matriculaService.corStatus(interesse.status)">
                  {{ matriculaService.formatarStatus(interesse.status) }}
                </ion-chip>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <strong>Data de Envio:</strong>
                <p>{{ interesse.dataEnvio | date:'dd/MM/yyyy HH:mm' }}</p>
              </ion-label>
            </ion-item>
          </ion-item-group>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Documentos Necessários -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Documentos Necessários</ion-card-title>
        <ion-card-subtitle>
          Lista de documentos que serão solicitados ao responsável
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div *ngIf="carregandoDocumentos" class="loading-container">
          <ion-spinner name="dots"></ion-spinner>
          <p class="loading-text">Carregando documentos...</p>
        </div>

        <ion-list *ngIf="!carregandoDocumentos && tiposDocumentos.length > 0" lines="full">
          <ion-item *ngFor="let tipo of tiposDocumentos" class="documento-item">
            <ion-icon
              [name]="tipo.requerAssinatura ? 'document-text-outline' : 'attach-outline'"
              slot="start"
              [color]="tipo.obrigatorio ? 'danger' : 'medium'">
            </ion-icon>

            <ion-label>
              <h3>{{ tipo.nome }}</h3>
              <p>{{ tipo.descricao }}</p>

              <div class="documento-tags">
                <ion-chip
                  [color]="tipo.obrigatorio ? 'danger' : 'medium'"
                  [outline]="!tipo.obrigatorio">
                  {{ tipo.obrigatorio ? 'Obrigatório' : 'Opcional' }}
                </ion-chip>

                <ion-chip
                  color="primary"
                  outline
                  *ngIf="tipo.requerAssinatura">
                  Requer Assinatura
                </ion-chip>

                <ion-chip
                  color="secondary"
                  outline
                  *ngIf="tipo.requerAnexo">
                  Requer Anexo
                </ion-chip>
              </div>
            </ion-label>
          </ion-item>
        </ion-list>

        <div *ngIf="!carregandoDocumentos && tiposDocumentos.length === 0" class="empty-state">
          <ion-icon name="document-outline" size="large"></ion-icon>
          <h3>Nenhum documento encontrado</h3>
          <p>Não há documentos configurados para este tipo de cota.</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Formulário de Início de Matrícula -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Iniciar Processo de Matrícula</ion-card-title>
        <ion-card-subtitle>
          Confirme as informações e inicie o processo
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <form [formGroup]="formulario" (ngSubmit)="iniciarMatricula()">
          <ion-list lines="full">
            <ion-item>
              <ion-label position="stacked">
                Observações (opcional)
              </ion-label>
              <ion-textarea
                formControlName="observacoes"
                rows="3"
                placeholder="Adicione observações sobre o início da matrícula..."
                maxlength="500">
              </ion-textarea>
            </ion-item>
          </ion-list>

          <!-- Informações Importantes -->
          <div class="info-alert">
            <ion-icon name="information-circle-outline"></ion-icon>
            <div>
              <h4>O que acontece ao iniciar a matrícula?</h4>
              <ul>
                <li>Um login será criado automaticamente para o responsável</li>
                <li>O responsável receberá as credenciais por e-mail</li>
                <li>A lista de documentos será disponibilizada no portal do responsável</li>
                <li>O status será alterado para "Matrícula Iniciada"</li>
              </ul>
            </div>
          </div>

          <!-- Botões de Ação -->
          <div class="action-buttons">
            <ion-button
              type="button"
              fill="clear"
              color="medium"
              (click)="voltar()">
              <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
              Voltar
            </ion-button>

            <ion-button
              type="submit"
              class="confirm-button"
              [disabled]="formulario.invalid || iniciando"
              expand="block">
              <ion-spinner
                *ngIf="iniciando"
                name="crescent"
                slot="start">
              </ion-spinner>
              <ion-icon
                *ngIf="!iniciando"
                name="play-outline"
                slot="start">
              </ion-icon>
              {{ iniciando ? 'Iniciando...' : 'Iniciar Matrícula' }}
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
