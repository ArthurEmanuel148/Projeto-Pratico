<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/sistema/matriculas/declaracoes"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-horizontal">
  <!-- Header com t√≠tulo e descri√ß√£o -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-info">
        <h1>Detalhe da Declara√ß√£o</h1>
        <p>Informa√ß√µes completas da declara√ß√£o de interesse</p>
      </div>
    </div>
  </div>

  <!-- Link de voltar para a listagem -->
  <div class="content-container">
    <div class="back-link">
      <ion-button fill="clear" color="primary" routerLink="/sistema/matriculas/declaracoes">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Voltar para a listagem
      </ion-button>
    </div>

    <!-- Conte√∫do da p√°gina -->
    <div *ngIf="!carregando && declaracao; else carregandoTpl" class="page-content">
      <ion-card *ngIf="declaracao">
        <ion-card-header>
          <ion-card-title>Dados do Aluno</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="dados-pessoais">
            <div class="campo-linha">
              <ion-label class="label-campo">Nome:</ion-label>
              <ion-text class="valor-campo nome-destaque">{{ declaracao.nomeAluno ||
                declaracao.nomeCompleto || (declaracao.dadosAluno &&
                declaracao.dadosAluno.nomeAluno) || 'N√£o informado' }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">Data de Nascimento:</ion-label>
              <ion-text class="valor-campo">{{ (declaracao.dataNascimentoAluno || (declaracao.dadosAluno &&
                declaracao.dadosAluno.dataNascimentoAluno)) | date:'dd/MM/yyyy' }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">CPF:</ion-label>
              <ion-text class="valor-campo">{{ declaracao.cpfAluno || declaracao.cpf || (declaracao.dadosAluno &&
                declaracao.dadosAluno.cpfAluno) || 'N√£o informado' }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">Protocolo:</ion-label>
              <ion-text class="valor-campo">{{ declaracao.protocolo }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">Status:</ion-label>
              <ion-badge color="primary">{{ declaracao.status || 'interesse_declarado' }}</ion-badge>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao && declaracao.dadosResponsavel">
        <ion-card-header>
          <ion-card-title>Dados do Respons√°vel</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="dados-pessoais">
            <div class="campo-linha">
              <ion-label class="label-campo">Nome:</ion-label>
              <ion-text class="valor-campo nome-destaque">{{ declaracao.nomeResponsavel ||
                (declaracao.dadosResponsavel &&
                declaracao.dadosResponsavel.nomeResponsavel) || 'N√£o informado' }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">CPF:</ion-label>
              <ion-text class="valor-campo">{{ declaracao.cpfResponsavel || (declaracao.dadosResponsavel &&
                declaracao.dadosResponsavel.cpfResponsavel) || 'N√£o informado' }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">Data de Nascimento:</ion-label>
              <ion-text class="valor-campo">{{ (declaracao.dataNascimentoResponsavel ||
                (declaracao.dadosResponsavel
                && declaracao.dadosResponsavel.dataNascimentoResponsavel)) | date:'dd/MM/yyyy' }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">Email:</ion-label>
              <ion-text class="valor-campo">{{ declaracao.emailResponsavel || declaracao.email ||
                (declaracao.dadosResponsavel
                &&
                declaracao.dadosResponsavel.emailResponsavel) || 'N√£o informado' }}</ion-text>
            </div>
            <div class="campo-linha">
              <ion-label class="label-campo">Telefone:</ion-label>
              <ion-text class="valor-campo">{{ declaracao.telefoneResponsavel || declaracao.telefone ||
                (declaracao.dadosResponsavel && declaracao.dadosResponsavel.telefoneResponsavel) || 'N√£o informado'
                }}</ion-text>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao">
        <ion-card-header>
          <ion-card-title>Vaga de Interesse</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p><strong>Tipo de Cota:</strong> {{ declaracao.tipoCota || (declaracao.tipoVaga &&
            declaracao.tipoVaga.tipoCota)
            }}</p>
          <p><strong>S√©rie Desejada:</strong> {{ declaracao.serieDesejada || 'N√£o informado' }}</p>
          <p><strong>Ano Letivo:</strong> {{ declaracao.anoLetivo || 'N√£o informado' }}</p>
          <p><strong>Tipo de Escola Anterior:</strong> {{ declaracao.tipoEscola || 'N√£o informado' }}</p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao">
        <ion-card-header>
          <ion-card-title>Dados da Escola Atual do Aluno</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p><strong>Nome da Escola:</strong> {{ declaracao.escolaAluno || 'N√£o informado' }}</p>
          <p><strong>C√≥digo INEP:</strong> {{ declaracao.codigoInepEscola || 'N√£o informado' }}</p>
          <p><strong>Munic√≠pio:</strong> {{ declaracao.municipioEscola || 'N√£o informado' }}</p>
          <p><strong>UF:</strong> {{ declaracao.ufEscola || 'N√£o informado' }}</p>
        </ion-card-content>
      </ion-card>

      <!-- Se√ß√£o de Datas Importantes -->
      <ion-card *ngIf="declaracao">
        <ion-card-header>
          <ion-card-title>Datas Importantes</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p><strong>Data de Envio da Declara√ß√£o:</strong> {{ (declaracao.dataEnvio | date:'dd/MM/yyyy HH:mm') || 'N√£o
            informado' }}</p>
          <p *ngIf="declaracao.dataInicioMatricula"><strong>Data de In√≠cio da Matr√≠cula:</strong> {{
            declaracao.dataInicioMatricula | date:'dd/MM/yyyy HH:mm' }}</p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao">
        <ion-card-header>
          <ion-card-title>Endere√ßo da Fam√≠lia</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p><strong>CEP:</strong> {{ declaracao.cep || 'N√£o informado' }}</p>
          <p><strong>Logradouro:</strong> {{ declaracao.logradouro || 'N√£o informado' }}</p>
          <p><strong>N√∫mero:</strong> {{ declaracao.numero || 'N√£o informado' }}</p>
          <p *ngIf="declaracao.complemento"><strong>Complemento:</strong> {{ declaracao.complemento }}</p>
          <p><strong>Bairro:</strong> {{ declaracao.bairro || 'N√£o informado' }}</p>
          <p><strong>Cidade:</strong> {{ declaracao.cidade || 'N√£o informado' }}</p>
          <p><strong>UF:</strong> {{ declaracao.uf || 'N√£o informado' }}</p>
          <p *ngIf="declaracao.pontoReferencia"><strong>Ponto de Refer√™ncia:</strong> {{ declaracao.pontoReferencia }}
          </p>

          <div class="endereco-completo" *ngIf="enderecoCompleto">
            <strong>Endere√ßo Completo:</strong>
            <p>{{ enderecoCompleto }}</p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao && declaracao.tipoCota === 'economica'">
        <ion-card-header>
          <ion-card-title>üí∞ Informa√ß√µes de Renda</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="info-row">
            <strong>N√∫mero de Integrantes da Fam√≠lia:</strong>
            <span>{{ declaracao.infoRenda?.numeroIntegrantes || 'N√£o informado' }}</span>
          </div>

          <div *ngIf="integrantesRenda && integrantesRenda.length > 0" class="renda-section">
            <h4>üë• Composi√ß√£o Familiar e Renda:</h4>

            <div class="tabela-container">
              <table class="tabela-integrantes">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Parentesco</th>
                    <th>Idade</th>
                    <th>Renda</th>
                    <th>Tipo Renda</th>
                    <th>Ocupa√ß√£o/Obs</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let integrante of integrantesRenda; let i = index">
                    <td class="nome-integrante">
                      <strong>{{ integrante.nome || 'Nome n√£o informado' }}</strong>
                      <small *ngIf="integrante.cpf" class="cpf-integrante">CPF: {{ integrante.cpf }}</small>
                      <small *ngIf="integrante.dataNascimento" class="data-nascimento">Nascimento: {{
                        integrante.dataNascimento | date:'dd/MM/yyyy' }}</small>
                    </td>
                    <td>{{ integrante.parentesco || 'N√£o informado' }}</td>
                    <td>
                      <span *ngIf="integrante.idade || integrante.idade === 0">{{ integrante.idade }} anos</span>
                      <span *ngIf="!integrante.idade && integrante.idade !== 0">-</span>
                    </td>
                    <td class="valor-renda">{{ integrante.renda ? (integrante.renda | currency:'BRL':'symbol':'1.2-2') :
                      'R$
                      0,00' }}</td>
                    <td>{{ integrante.tipoRenda || '-' }}</td>
                    <td class="observacoes-col">
                      <span *ngIf="integrante.ocupacao">{{ integrante.ocupacao }}</span>
                      <span *ngIf="integrante.observacoes" class="obs-extra">{{ integrante.observacoes }}</span>
                      <span *ngIf="!integrante.ocupacao && !integrante.observacoes">-</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="renda-total" *ngIf="rendaFamiliarCalculada > 0">
              <p><strong>Renda Familiar Total:</strong> {{ rendaFamiliarCalculada | currency:'BRL':'symbol':'1.2-2' }}
              </p>
              <p><strong>Renda Per Capita:</strong> {{ rendaPerCapitaCalculada | currency:'BRL':'symbol':'1.2-2' }}</p>
            </div>
          </div>

          <div *ngIf="!integrantesRenda || integrantesRenda.length === 0">
            <p style="color: #888; font-style: italic;">Dados de renda n√£o informados</p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao && declaracao.horariosVaga?.horariosSelecionados">
        <ion-card-header>
          <ion-card-title>Hor√°rios de Interesse</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div *ngIf="horariosSelecionados && horariosSelecionados.length > 0">
            <ion-list>
              <ion-item *ngFor="let horario of horariosSelecionados">
                <ion-label>{{ horario }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
          <p *ngIf="!horariosSelecionados || horariosSelecionados.length === 0">Nenhum hor√°rio espec√≠fico selecionado
          </p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao && (declaracao.observacoesResponsavel || declaracao.mensagemAdicional)">
        <ion-card-header>
          <ion-card-title>Observa√ß√µes do Respons√°vel</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p *ngIf="declaracao.observacoesResponsavel"><strong>Observa√ß√µes:</strong> {{
            declaracao.observacoesResponsavel }}
          </p>
          <p *ngIf="declaracao.mensagemAdicional"><strong>Mensagem Adicional:</strong> {{ declaracao.mensagemAdicional
            }}
          </p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="declaracao && declaracao.observacoes">
        <ion-card-header>
          <ion-card-title>Observa√ß√µes Internas</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ declaracao.observacoes }}</p>
        </ion-card-content>
      </ion-card>

      <!-- Bot√£o de iniciar matr√≠cula -->
      <div class="action-section">
        <ion-button expand="block" color="success" (click)="iniciarMatricula()" *ngIf="!matriculaIniciada">
          <ion-icon name="school-outline" slot="start"></ion-icon>
          Selecionar Turma e Iniciar Matr√≠cula
        </ion-button>
      </div>

      <ion-card *ngIf="matriculaIniciada">
        <ion-card-header>
          <ion-card-title color="success">
            <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
            Matr√≠cula Iniciada com Sucesso!
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="credentials-section">
            <h3>Credenciais do Respons√°vel</h3>
            <ion-item lines="none">
              <ion-label>
                <h4><strong>Usu√°rio:</strong></h4>
                <p>{{ loginGerado?.usuario }}</p>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-label>
                <h4><strong>Senha:</strong></h4>
                <p>{{ loginGerado?.senha }}</p>
              </ion-label>
            </ion-item>
            <ion-button expand="block" fill="outline" color="primary" (click)="copiarCredenciais()">
              <ion-icon name="copy-outline" slot="start"></ion-icon>
              Copiar Credenciais
            </ion-button>
          </div>

          <!-- Se√ß√£o removida: Documentos Necess√°rios n√£o fazem parte do sistema -->

          <!-- Nova se√ß√£o para documentos enviados -->
          <div class="documents-section" *ngIf="!carregandoDocumentos">
            <h3>Documentos Enviados</h3>
            <div *ngIf="documentosEnviados.length > 0; else nenhumDocumentoEnviado">
              <div class="documentos-grid">
                <div class="documento-card" *ngFor="let doc of documentosEnviados">
                  <div class="documento-header">
                    <ion-icon name="document-text-outline" [color]="getStatusColor(doc.status)"></ion-icon>
                    <div class="documento-title">
                      <h4>{{ doc.tipoDocumento.nome }}</h4>
                      <ion-badge [color]="getStatusColor(doc.status)" class="status-badge">
                        {{ doc.statusDescricao }}
                      </ion-badge>
                    </div>
                  </div>

                  <div class="documento-info">
                    <div class="info-linha">
                      <span class="label">Respons√°vel:</span>
                      <span class="valor">{{ doc.nomeResponsavel }}</span>
                    </div>
                    <div class="info-linha">
                      <span class="label">Parentesco:</span>
                      <span class="valor">{{ doc.parentesco }}</span>
                    </div>
                    <div class="info-linha" *ngIf="doc.dataEnvio">
                      <span class="label">Enviado em:</span>
                      <span class="valor">{{ doc.dataEnvio | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                  </div>

                  <div class="documento-acoes">
                    <ion-button size="small" fill="outline" color="primary" (click)="abrirDocumento(doc)"
                      [disabled]="!doc.nomeArquivo || doc.nomeArquivo === 'null'">
                      <ion-icon name="open-outline" slot="start"></ion-icon>
                      {{ (doc.nomeArquivo && doc.nomeArquivo !== 'null') ? 'Abrir Documento' : 'N√£o anexado' }}
                    </ion-button>

                    <!-- Bot√µes de aprova√ß√£o/rejei√ß√£o para funcion√°rios -->
                    <div class="acoes-funcionario" *ngIf="isFuncionario() && doc.status === 'enviado'">
                      <ion-button size="small" fill="solid" color="success" (click)="aprovarDocumento(doc)">
                        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
                        Aprovar
                      </ion-button>
                      <ion-button size="small" fill="solid" color="danger" (click)="rejeitarDocumento(doc)">
                        <ion-icon name="close-outline" slot="start"></ion-icon>
                        Rejeitar
                      </ion-button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #nenhumDocumentoEnviado>
              <ion-note color="medium" class="ion-margin">
                <ion-icon name="information-circle-outline" slot="start"></ion-icon>
                Nenhum documento foi enviado ainda.
              </ion-note>
            </ng-template>
          </div>

          <div *ngIf="carregandoDocumentos" class="ion-text-center ion-margin">
            <ion-spinner></ion-spinner>
            <p>Carregando documentos enviados...</p>
          </div>

          <ion-note color="primary" class="ion-margin-top">
            <ion-icon name="information-circle-outline" slot="start"></ion-icon>
            Oriente o respons√°vel a acessar o sistema com essas credenciais para anexar ou assinar os documentos
            pendentes.
          </ion-note>

          <!-- Bot√£o Finalizar Matr√≠cula -->
          <div class="ion-margin-top" *ngIf="podeFinalizarMatricula()">
            <ion-button expand="block" color="success" (click)="finalizarMatricula()"
              [disabled]="processandoFinalizacao">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
              {{ processandoFinalizacao ? 'Finalizando...' : 'Finalizar Matr√≠cula' }}
            </ion-button>
            <ion-note color="medium" class="ion-margin-top">
              <ion-icon name="information-circle-outline" slot="start"></ion-icon>
              Ao finalizar, a matr√≠cula ser√° conclu√≠da e o aluno aparecer√° na listagem de turmas.
            </ion-note>
          </div>

          <div class="ion-margin-top">
            <ion-button expand="block" color="primary" (click)="voltarLista()">
              <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
              Voltar para a Lista de Declara√ß√µes
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

    </div> <!-- Fecha page-content -->
  </div> <!-- Fecha content-container -->

  <ng-template #carregandoTpl>
    <div class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Carregando detalhes da declara√ß√£o...</p>
    </div>
  </ng-template>

</ion-content>